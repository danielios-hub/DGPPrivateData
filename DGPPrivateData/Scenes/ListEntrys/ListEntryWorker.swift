//
//  ListEntryWorker.swift
//  DGPPrivateData
//
//  Created by Daniel Gallego Peralta on 4/3/21.
//  Copyright (c) 2021 ___ORGANIZATIONNAME___. All rights reserved.
//
//  This file was generated by the Clean Swift Xcode Templates so
//  you can apply clean architecture to your iOS and Mac projects,
//  see http://clean-swift.com
//

import UIKit

class ListEntryWorker {
    
    var dataStore: PreferencesService
    var masterDataSource: RepositoryService
    
    init(dataStore: PreferencesService, masterDataSource: RepositoryService) {
        self.dataStore = dataStore
        self.masterDataSource = masterDataSource
    }
    
    func fetchEntrys(textSearch: String? = nil, completionHandler: ([Entry]) -> Void ) {
        
        let filtersName = dataStore.filterList.filter {
            $0.state
        }.compactMap {
            return $0.title != Filter.favoriteFilterName ? $0.title : nil
        }
        
        let categoriesFilter = FilterType.categories(filtersName)
        
        let order = dataStore.orderList.filter { $0.title == "Alphabetically" }.first
        
        let orderFilter = FilterType.order(order?.state == true ? .alphabetically : .default)
        
        var filtersType = [categoriesFilter, orderFilter]
        
        if let textSearch = textSearch {
            filtersType.append(FilterType.search(textSearch))
        }
        
        if let isFavorite = dataStore.filterList.filter({ $0.title == Filter.favoriteFilterName}).first?.state, isFavorite {
            filtersType.append(FilterType.isFavorite(true))
        }
        
        completionHandler(
            masterDataSource.getAllEntries(filters: filtersType))
    }
}
